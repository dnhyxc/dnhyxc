<!--
 * 文章目录
 * @author: dnhyxc
 * @since: 2023-01-14
 * index.vue
-->
<template>
  <div v-if="commonStore?.tocTitles?.length > 0" ref="tocRef" class="toc-wrap">
    <div class="title">
      <span>目录</span>
      <i
        :class="`font iconfont ${scrollChildTop > 0 ? 'icon-shuangjiantou-shang' : 'icon-shuangjiantou-xia'}`"
        @click="onScrollTo"
      />
    </div>
    <el-scrollbar ref="scrollChildRef" wrap-class="scrollbar-wrapper">
      <div id="item-wrap" class="item-wrap">
        <div
          v-for="(anchor, index) in commonStore.tocTitles"
          :key="index"
          :style="{ padding: `2px 10px 2px ${anchor.indent * 20 + 15}px`, margin: '5px 0' }"
          :class="`${checkTocTitle === anchor.title + index && 'toc-item'} item item-${anchor.lineIndex!}`"
          @click="handleAnchorClick(anchor, index)"
        >
          <a style="cursor: pointer" :class="checkTocTitle === anchor.title + index && 'active'">{{ anchor.title }}</a>
        </div>
      </div>
    </el-scrollbar>
  </div>
</template>

<script setup lang="ts">
import { onMounted, ref, nextTick, watchEffect, onUnmounted } from 'vue';
import { scrollTo, debounce } from '@/utils';
import { useChildScroller } from '@/hooks';
import { commonStore } from '@/store';
import { TocTitlesParams } from '@/typings/common';

interface IProps {
  isEnter: boolean;
}

const { scrollChildRef, scrollChildTop } = useChildScroller();

const checkTocTitle = ref<string>('');

const props = defineProps<IProps>();

onMounted(() => {
  watchEffect(() => {
    if (commonStore.tocTitles[0]) {
      checkTocTitle.value = commonStore.tocTitles[0]?.title + 0;
    }
    nextTick(() => {
      // 监听滚动条滚动事件debounce(onResize, 100)
      commonStore.detailScrollRef?.wrapRef?.addEventListener('scroll', debounce(onDetailScroll, 100));
    });
  });
});

onUnmounted(() => {
  // 卸载滚动条滚动事件
  commonStore.detailScrollRef?.wrapRef?.removeEventListener('scroll', onDetailScroll);
});

// 监听详情md预览组件滚动事件
const onDetailScroll = (e: Event) => {
  if (props.isEnter) {
    const element = e.target as HTMLDivElement;
    const { scrollTop } = element;
    let closestSection = null;
    for (let i = 0; i < commonStore.tocTops.length - 1; i++) {
      if (scrollTop >= commonStore.tocTops[i].top && scrollTop < commonStore.tocTops[i + 1].top) {
        closestSection = commonStore.tocTops[i];
        break;
      }
    }
    if (!closestSection && scrollTop >= commonStore.tocTops[commonStore.tocTops.length - 1].top) {
      closestSection = commonStore.tocTops[commonStore.tocTops.length - 1];
    }
    if (closestSection) {
      checkTocTitle.value = closestSection.title;
      const tocEl = scrollChildRef.value?.wrapRef as any;
      const heading = tocEl.querySelector(`.item-${closestSection.lineIndex}`) as HTMLElement;
      if (heading) {
        heading.classList.add('header-active');
        tocEl.scrollTo({
          top: heading.offsetTop,
          behavior: 'smooth',
        });
      }
    }
  }
};

// 选中某标题
const handleAnchorClick = (anchor: TocTitlesParams, index: number) => {
  const { lineIndex, title } = anchor;
  checkTocTitle.value = title + index;
  nextTick(() => {
    const heading = (commonStore.previewRef as any).$el?.querySelector(`[data-v-md-line="${lineIndex}"]`);
    if (heading) {
      heading.classList.add('header-active');
      (commonStore.previewRef as any).scrollToTarget({
        target: heading,
        scrollContainer: commonStore.detailScrollRef?.wrapRef, // 需要滚动组件容器（el-scrollbar）
      });
    }
  });
};

// 滚动到某位置
const onScrollTo = () => {
  const bottom = scrollChildRef.value?.wrapRef?.firstElementChild?.firstElementChild?.offsetHeight;
  scrollTo(scrollChildRef, scrollChildTop.value > 0 ? 0 : bottom);
};
</script>

<style scoped lang="less">
@import '@/styles/index.less';

.toc-wrap {
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
  border-radius: 5px;
  overflow: hidden;
  box-shadow: 0 0 5px 0 var(--card-shadow);
  padding-bottom: 10px;
  margin-bottom: 10px;
  color: var(--font-2);

  .title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    font-size: 18px;
    font-weight: 700;
    border-bottom: 1px solid var(--card-border);
    border-top-left-radius: 5px;
    border-top-right-radius: 5px;

    .font {
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;

      &:hover {
        color: var(--active);
      }
    }
  }

  :deep {
    .scrollbar-wrapper {
      box-sizing: border-box;
    }

    .el-scrollbar__view {
      box-sizing: border-box;
      height: 100%;
      border: 1px solid transparent;
    }
  }

  .item {
    .ellipsisMore(1);

    &:hover {
      color: var(--theme-blue);
    }
  }

  .toc-item {
    box-sizing: border-box;
    position: relative;
    width: 100%;

    &::before {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      content: '';
      height: 65%;
      width: 4px;
      background-color: var(--theme-blue);
      border-top-right-radius: 5px;
      border-bottom-right-radius: 5px;
    }
  }

  .active {
    color: var(--theme-blue);
  }
}
</style>
